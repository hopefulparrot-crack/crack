<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>댓글</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      background:#111;
      color:#fff;
      font-family:system-ui;
      max-width:500px;
      margin:auto;
      padding:20px;
    }
    .comment {
      background:#1f1f1f;
      padding:10px;
      border-radius:8px;
      margin-bottom:8px;
      font-size:14px;
    }
    .reply {
      margin-left:20px;
      background:#222;
    }
    textarea {
      width:100%;
      height:70px;
      padding:10px;
      border-radius:8px;
      border:none;
      resize:none;
      margin-top:6px;
    }
    button {
      margin-top:6px;
      padding:6px 10px;
      border:none;
      border-radius:6px;
      background:#4f46e5;
      color:white;
      font-size:13px;
    }
    .reply-box {
      display:none;
      margin-top:6px;
    }
  </style>
</head>
<body>

<h3>댓글</h3>
<div id="list"></div>

<textarea id="newText" placeholder="댓글을 입력하세요"></textarea>
<button onclick="sendComment()">댓글 달기</button>

<script>
const SUPABASE_URL = "https://네프로젝트.supabase.co"
const SUPABASE_ANON_KEY = "네_anon_key"

const sb = supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
)

async function load() {
  const { data } = await sb
    .from("comments")
    .select("*")
    .order("id", { ascending: true })

  const list = document.getElementById("list")
  list.innerHTML = ""

  const map = {}
  data.forEach(c => map[c.id] = { ...c, replies: [] })
  data.forEach(c => {
    if (c.parent_id) {
      map[c.parent_id]?.replies.push(map[c.id])
    }
  })

  Object.values(map)
    .filter(c => !c.parent_id)
    .forEach(c => renderComment(c, list))
}

function renderComment(c, container) {
  const div = document.createElement("div")
  div.className = "comment"
  div.textContent = c.content

  const replyBtn = document.createElement("button")
  replyBtn.textContent = "답글"
  replyBtn.onclick = () => {
    box.style.display = box.style.display === "none" ? "block" : "none"
  }

  const box = document.createElement("div")
  box.className = "reply-box"

  const ta = document.createElement("textarea")
  ta.placeholder = "대댓글 입력"

  const sendBtn = document.createElement("button")
  sendBtn.textContent = "등록"
  sendBtn.onclick = async () => {
    const text = ta.value.trim()
    if (!text) return

    await sb.from("comments").insert({
      content: text,
      parent_id: c.id
    })

    await notify(text, c.id)
    load()
  }

  box.appendChild(ta)
  box.appendChild(sendBtn)

  div.appendChild(document.createElement("br"))
  div.appendChild(replyBtn)
  div.appendChild(box)
  container.appendChild(div)

  c.replies.forEach(r => {
    const rd = document.createElement("div")
    rd.className = "comment reply"
    rd.textContent = r.content
    container.appendChild(rd)
  })
}

async function sendComment() {
  const text = document.getElementById("newText").value.trim()
  if (!text) return alert("내용 입력해")

  await sb.from("comments").insert({ content: text })
  await notify(text, null)

  document.getElementById("newText").value = ""
  load()
}

async function notify(content, parent_id) {
  await fetch(
    `${SUPABASE_URL}/functions/v1/comment-notify`,
    {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${SUPABASE_ANON_KEY}`
      },
      body: JSON.stringify({ content, parent_id })
    }
  )
}

load()
</script>

</body>
</html>
