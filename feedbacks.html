<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>피드백&댓글</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body{background:#111;color:#fff;font-family:system-ui;max-width:500px;margin:auto;padding:20px}
.comment{background:#1f1f1f;padding:10px;border-radius:8px;margin-bottom:8px}
.reply{margin-left:20px;background:#222}
textarea{width:100%;height:70px;border-radius:8px;border:none;padding:10px}
button{margin-top:6px;padding:6px 10px;border:none;border-radius:6px;background:#4f46e5;color:#fff}
</style>
</head>
<body>

<h3>댓글</h3>
<div id="list"></div>

<textarea id="text" placeholder="댓글 입력"></textarea>
<button onclick="send()">댓글 달기</button>

<script>
const URL = "https://zhebwptomqfabevvzncg.supabase.co"
const KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpoZWJ3cHRvbXFmYWJldnZ6bmNnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2ODE5MTgsImV4cCI6MjA4MTI1NzkxOH0.Q7UdL6AVCzb6AbsmMA847yulWISqaZwYZW9hvMai_kg"
const sb = supabase.createClient(URL, KEY)

async function load(){
  const {data}=await sb.from("comments").select("*").order("id")
  const map={}
  data.forEach(c=>map[c.id]={...c,replies:[]})
  data.forEach(c=>c.parent_id&&map[c.parent_id]?.replies.push(map[c.id]))

  list.innerHTML=""
  Object.values(map).filter(c=>!c.parent_id)
    .forEach(c=>render(c,list))
}

function render(c,root){
  const d=document.createElement("div")
  d.className="comment"
  d.textContent=c.content

  const btn=document.createElement("button")
  btn.textContent="답글"
  btn.onclick=()=>box.style.display=box.style.display?"":"block"

  const box=document.createElement("div")
  box.style.display="none"

  const ta=document.createElement("textarea")
  const sbt=document.createElement("button")
  sbt.textContent="등록"
  sbt.onclick=()=>sendReply(c.id,ta.value)

  box.append(ta,sbt)
  d.append(document.createElement("br"),btn,box)
  root.appendChild(d)

  c.replies.forEach(r=>{
    const rd=document.createElement("div")
    rd.className="comment reply"
    rd.textContent=r.content
    root.appendChild(rd)
  })
}

async function send(){
  const t=text.value.trim()
  if(!t)return
  const res=await fetch(`${URL}/functions/v1/comment-notify`,{
    method:"POST",
    headers:{Authorization:`Bearer ${KEY}`,"Content-Type":"application/json"},
    body:JSON.stringify({content:t})
  })
  if(!res.ok)return alert("등록 불가")
  await sb.from("comments").insert({content:t})
  text.value=""
  load()
}

async function sendReply(pid,t){
  if(!t)return
  const res=await fetch(`${URL}/functions/v1/comment-notify`,{
    method:"POST",
    headers:{Authorization:`Bearer ${KEY}`,"Content-Type":"application/json"},
    body:JSON.stringify({content:t,parent_id:pid})
  })
  if(!res.ok)return alert("등록 불가")
  await sb.from("comments").insert({content:t,parent_id:pid})
  load()
}

load()
</script>
</body>
</html>
