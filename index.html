<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>댓글&피드백</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body{
  background:#111;color:#fff;
  font-family:system-ui;
  max-width:500px;
  margin:auto;padding:20px
}
.comment{
  background:#1f1f1f;
  padding:10px;
  border-radius:8px;
  margin-bottom:8px
}
.reply{
  margin-left:20px;
  background:#222
}
textarea{
  width:100%;height:70px;
  border-radius:8px;
  border:none;
  padding:10px;
  box-sizing:border-box
}
button{
  margin-top:6px;
  padding:6px 10px;
  border:none;
  border-radius:6px;
  background:#4f46e5;
  color:#fff
}
.reply-box{display:none;margin-top:6px}
</style>
</head>
<body>

<h3>댓글</h3>
<div id="list"></div>

<textarea id="text" placeholder="댓글 입력"></textarea>
<button onclick="send()">댓글 달기</button>

<script>
const SUPABASE_URL = "https://zhebwptomqfabevvzncg.supabase.co"
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpoZWJ3cHRvbXFmYWJldnZ6bmNnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2ODE5MTgsImV4cCI6MjA4MTI1NzkxOH0.Q7UdL6AVCzb6AbsmMA847yulWISqaZwYZW9hvMai_kg"

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
const NOTIFY_URL = SUPABASE_URL + "/functions/v1/notify"

async function load(){
  const { data, error } = await sb
    .from("comments")
    .select("*")
    .order("id", { ascending: true })

  if (error) {
    alert(error.message)
    return
  }

  list.innerHTML = ""
  const map = {}
  data.forEach(c => map[c.id] = { ...c, replies: [] })
  data.forEach(c => c.parent_id && map[c.parent_id]?.replies.push(map[c.id]))

  Object.values(map)
    .filter(c => !c.parent_id)
    .forEach(render)
}

function render(c){
  const d = document.createElement("div")
  d.className = "comment"
  d.textContent = c.content

  const btn = document.createElement("button")
  btn.textContent = "답글"

  const box = document.createElement("div")
  box.className = "reply-box"

  btn.onclick = () => {
    box.style.display = box.style.display ? "" : "block"
  }

  const ta = document.createElement("textarea")
  ta.placeholder = "대댓글 입력"

  const sbt = document.createElement("button")
  sbt.textContent = "등록"
  sbt.onclick = () => sendReply(c.id, ta.value)

  box.append(ta, sbt)
  d.append(document.createElement("br"), btn, box)
  list.appendChild(d)

  c.replies.forEach(r => {
    const rd = document.createElement("div")
    rd.className = "comment reply"
    rd.textContent = r.content
    list.appendChild(rd)
  })
}

async function notify(payload){
  try{
    await fetch(NOTIFY_URL, {
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization":`Bearer ${SUPABASE_ANON_KEY}`
      },
      body:JSON.stringify(payload)
    })
  }catch(e){}
}

async function send(){
  const text = document.getElementById("text").value.trim()
  if (!text) return

  const { error } = await sb
    .from("comments")
    .insert({ content: text })

  if (error) {
    alert(error.message)
    return
  }

  notify({ content: text })
  document.getElementById("text").value = ""
  load()
}

async function sendReply(parentId, text){
  text = text.trim()
  if (!text) return

  const { error } = await sb
    .from("comments")
    .insert({
      content: text,
      parent_id: parentId
    })

  if (error) {
    alert(error.message)
    return
  }

  notify({ content: text, parent_id: parentId })
  load()
}

load()
</script>

</body>
</html>
